(function(f){function o(a,b){var c=new l(a,b),d=null;c.getViewer$=function(){if(d)return d;return d=f(document.createElement("div")).width(this.$sourceElement.width()).height(this.$sourceElement.height())};c.updateViewer=function(){var e=this.getViewer$(),g=this.currentRotation,h=Math.floor(g/this.rotationsPerFrame);g=g%this.rotationsPerFrame*e.height();e.css({backgroundImage:"url("+escape(this.frameImages[h].attr("src"))+")",backgroundPosition:"0 "+g+"px"})};return c}function q(a,b){var c=new l(a,
b),d=null;c.getViewer$=function(){if(d)return d;var e=document.createElement("canvas");e.width=this.$sourceElement.width();e.height=this.$sourceElement.height();return d=f(e)};c.updateViewer=function(){var e=this.currentRotation,g=Math.floor(e/this.rotationsPerFrame);e=e%this.rotationsPerFrame;var h=this.getViewer$()[0].getContext("2d"),p=h.canvas.width,m=h.canvas.height;h.drawImage(this.frameImages[g][0],0,e*m,p,m,0,0,p,m)};return c}function j(a){var b=f(document.createElement("div")).gxInit({queue:"cancel"}).css({position:"absolute"}).css(i).hide();
a.data("toolTipIt",{title:a.attr("title"),$toolTip:b,hideTimer:null}).attr("title","").bind("mouseenter",j.enter).bind("mouseleave",j.leave);return b}function r(){try{if(document.createElement("canvas").getContext)return q}catch(a){return o}return o}var i={opacity:0},k={opacity:1};if(!f.support.opacity){i={};k={}}var l=function(a,b){this.$sourceElement=a;this.options=b;this.$sourceElement.css({cursor:this.options.loadTrigger==="click"?"pointer":undefined}).disableSelection();this.$container=f(document.createElement("div")).addClass("orbiter").css({display:"inline-block",
position:"relative"}).disableSelection().data("orbiter",this);this.$featureBoxContainer=f(document.createElement("div")).css({display:"block",position:"absolute",left:0,right:0,top:0,bottom:0}).hide().css(i).gxInit({queue:"cancel"}).appendTo(this.$container);this.rotationCount=b.rotationCount;this.rotationsPerFrame=b.rotationsPerFrame;this.pixelsPerRotation=b.pixelsPerRotation;this.features=this.options.features;this.frameImages=[];this.featureBoxes={};this.isLoaded=false;this.bind()};l.prototype=
{updateViewer:function(){throw"Implement updateViewer in a subclass";},getViewer$:function(){throw"Implement getViewer$ i na subclass";},bind:function(){function a(e){if(f.browser.msie)return e.button===1;return e.button===0}function b(e){a(e)&&d.move(e.screenX,e.screenY)}function c(e){if(a(e)){d.up(e.screenX,e.screenY);f(document).unbind("mousemove",b)}}var d=this;this.$container.bind("mousedown",function(e){if(a(e)){d.down(e.screenX,e.screenY);f(document).one("mouseup",c);f(document).bind("mousemove",
b)}});this.$container[0].ontouchstart=function(e){e.preventDefault();d.down(e.targetTouches[0].screenX,e.targetTouches[0].screenY);return true};this.$container[0].ontouchmove=function(e){e.preventDefault();d.move(e.targetTouches[0].screenX,e.targetTouches[0].screenY);return true};this.$container[0].ontouchend=function(e){e.preventDefault();d.up();return true};this.$container.bind("mouseenter",function(){d.$featureBoxContainer.show().gx(k,d.options.featureMouseInTime,d.options.featureMouseInEasing)});
this.$container.bind("mouseleave",function(){d.$featureBoxContainer.gx(i,d.options.featureMouseOutTime,d.options.featureMouseOutEasing,function(){d.$featureBoxContainer.hide()})})},load:function(){if(!this.isLoaded){this.showLoading();var a=this;this.loadAllFrames(function(){a.isLoaded=true;a.setRotation(0);a.getViewer$().appendTo(a.$container);a.$container.css({width:a.$sourceElement.width(),height:a.$sourceElement.height()});a.hideLoading(function(){a.$sourceElement.replaceWith(a.$container)})})}},
showLoading:function(){if(this.options.showLoading){var a=this;this.$sourceElement.css({cursor:"wait"});this.loadingTimeout=window.setTimeout(function(){var b=a.$sourceElement.offset();b.width=a.$sourceElement.width();b.height=a.$sourceElement.height();var c={width:32,height:32};a.$sourceElement.animate({opacity:0.5},500);a.$loading=f(document.createElement("img")).attr("src","images/loader.gif").css({position:"absolute",left:b.left+(b.width-c.width)/2,top:b.top+(b.height-c.height)/2}).appendTo(document.body)},
0)}},hideLoading:function(a){if(this.options.showLoading){this.loadingTimeout&&window.clearTimeout(this.loadingTimeout);this.$sourceElement.css({cursor:""}).animate({opacity:1},200,a);if(this.$loading){this.$loading.remove();this.$loading=null}}else a()},loadAllFrames:function(a){function b(){--d;d<=0&&a()}var c=Math.ceil(this.rotationCount/this.rotationsPerFrame),d=c,e;for(e=0;e<c;++e)this.loadFrameImage(e,b)},wrapRotation:function(a){var b=this.rotationCount;if(b===0)return 0;for(;a>=b;)a-=b;for(;a<
0;)a+=b;return a},setRotation:function(a){if(parseInt(a,10)!=a)throw"Rotation number must be an integer";a=parseInt(a,10);if(a<0||a>=this.rotationCount)throw"Rotation number out of range";if(a!==this.currentRotation){this.currentRotation=a;this.updateViewer();this.updateFeatureBoxes()}},updateFeatureBoxes:function(){var a=this,b=this.getFeatures(this.currentRotation),c=f(c).map(function(){return this.name}).get();f.each(this.featureBoxes,function(d,e){if(f(c).index(d)<0)if(!e.isFadingOut){e.gx(i,
a.options.featureFadeOutTime,a.options.featureFadeOutEasing,function(){delete a.featureBoxes[d];e.hide()});e.isFadingOut=true}});f(b).each(function(){var d=a.featureBoxes[this.name];if(d){d.isFadingOut=false;d.show();d.gx(f.extend({},k,this.position),a.options.featureFadeInTime,a.options.featureFadeInEasing)}else{d=f(document.createElement("div")).addClass("orbiter-feature").css(this.position).css({position:"absolute"}).css(i).attr("title",this.name).gxInit({queue:"cancel"}).gx(k,a.options.featureFadeInTime,
a.options.featureFadeInEasing).appendTo(a.$featureBoxContainer);j(d).addClass("feature-tool-tip")}a.featureBoxes[this.name]=d})},getFeatures:function(a){var b=[];f.each(this.features,function(c,d){d[a]&&b.push({name:c,position:d[a]})});return b},loadFrameImage:function(a,b){var c=this.frameImages[a];if(c)c.data("callbacks")?c.data("callbacks").push(b):b(c);else{c=this.options.frameImage;var d;if(typeof c==="function")c=c(this.$sourceElement,a);if(typeof c==="string"){d=c;c=new Image}if(c.tagName&&
c.tagName==="IMG")c=f(c);if(!(c instanceof f))throw"image should be a jQuery object";this.frameImages[a]=c;c.data("callbacks",[b]);c.load(function(){f(c.data("callbacks")).each(function(){this(c)})});d&&c.attr("src",d)}},down:function(a,b){this.isDown=true;this.startX=a;this.startY=b;this.startTick=this.getTimeTick();this.startRotation=this.currentRotation;this.endMomentum()},move:function(a){this.isDown&&this.setRotation(this.wrapRotation(this.startRotation+Math.round((this.startX-a)/this.pixelsPerRotation)))},
up:function(a){if(this.isDown){this.isDown=false;this.startMomentum((this.startX-a)/(this.getTimeTick()-this.startTick))}},getTimeTick:function(){return(new Date).getTime()},startMomentum:function(a){function b(){d-=0.05;if(d<0)g.endMomentum();else{c+=e;g.setRotation(g.wrapRotation(c));var h=20/d;if(!(h>400))g.momentumTimer=window.setTimeout(b,h)}}if(a!==0){var c=this.currentRotation,d=Math.min(2.5,Math.abs(a)),e=Math.abs(a)/a;if(!(d<1)){var g=this;b()}}},endMomentum:function(){window.clearTimeout(this.momentumTimer)}};
j.enter=function(){var a=f(this),b=a.data("toolTipIt");a.offset();if(b.hideTimer){window.clearTimeout(b.hideTimer);b.hideTimer=null}b.$toolTip.text(b.title).show().gx(k,300,"Quad:Out");b.$toolTip.appendTo(a).css({top:-b.$toolTip.outerHeight()-1})};j.leave=function(){var a=f(this).data("toolTipIt");if(a.hideTimer){window.clearTimeout(a.hideTimer);a.hideTimer=null}a.hideTimer=window.setTimeout(function(){a.hideTimer=null;a.$toolTip.gx(i,300,"Sine",function(){a.$toolTip.css({top:0}).remove()})},500)};
var n=function(a){a=f.extend({},n.defaultOptions,a);this.each(function(){var b=f(this);try{var c=new (r())(b,a);switch(a.loadTrigger){default:c.load();break;case "click":b.one("mousedown",function(){c.load()});break;case "hover":b.one("mouseenter",function(){c.load()})}b.data("orbiter",c)}catch(d){console.log("Exception in $.fn.orbit: ");console.log(d)}})};n.defaultOptions={rotationCount:32,frameImage:function(a,b){var c=a.attr("src");c=c.replace("-thumb","-"+b);return c=c.replace(/#.*$/,"")},features:{},
featureFadeInTime:300,featureFadeOutTime:600,featureFadeInEasing:"Sine:Out",featureFadeOutEasing:"Sine:Out",featureMouseInTime:500,featureMouseOutTime:1E3,featureMouseInEasing:"Expo",featureMouseOutEasing:"Expo",rotationsPerFrame:1,pixelsPerRotation:10,showLoading:false,loadTrigger:"now"};f.fn.orbit=n;f.fn.disableSelection=function(){return this.bind("selectstart.disableSelection mousedown.disableSelection",function(a){a.preventDefault()}).attr("unselectable","unselectable")};f(function(){f("img.auto-orbit").each(function(){var a=
f(this),b=a.attr("src").replace(/^[^#]*#/,"");b=f.parseJSON(b);a.orbit(b)})})})(jQuery);