(function(d){function l(a,b){var c=new j(a,b),e=null;c.getViewer$=function(){return e?e:e=d(document.createElement("div")).width(this.$sourceElement.width()).height(this.$sourceElement.height())};c.updateViewer=function(){var a=this.getViewer$(),c=this.currentRotation,b=Math.floor(c/this.rotationsPerFrame),c=c%this.rotationsPerFrame*a.height();a.css({backgroundImage:"url("+escape(this.frameImages[b].attr("src"))+")",backgroundPosition:"0 "+c+"px"})};return c}function m(a,b){var c=new j(a,b),e=null;
c.getViewer$=function(){if(e)return e;var a=document.createElement("canvas");a.width=this.$sourceElement.width();a.height=this.$sourceElement.height();return e=d(a)};c.updateViewer=function(){var a=this.currentRotation,c=Math.floor(a/this.rotationsPerFrame),a=a%this.rotationsPerFrame,b=this.getViewer$()[0].getContext("2d"),e=b.canvas.width,d=b.canvas.height;b.drawImage(this.frameImages[c][0],0,a*d,e,d,0,0,e,d)};return c}function g(a){var b=d(document.createElement("div")).gxInit({queue:"cancel"}).css({position:"absolute"}).css(f).hide();
a.data("toolTipIt",{title:a.attr("title"),$toolTip:b,hideTimer:null}).attr("title","").bind("mouseenter",g.enter).bind("mouseleave",g.leave);return b}var f={opacity:0},i={opacity:1};d.support.opacity||(f={},i={});var j=function(a,b){this.$sourceElement=a;this.options=b;this.$sourceElement.css({cursor:"click"===this.options.loadTrigger?"pointer":void 0}).disableSelection();this.$container=d(document.createElement("div")).addClass("orbiter").css({display:"inline-block",position:"relative"}).disableSelection().data("orbiter",
this);this.$featureBoxContainer=d(document.createElement("div")).css({display:"block",position:"absolute",left:0,right:0,top:0,bottom:0}).hide().css(f).gxInit({queue:"cancel"}).appendTo(this.$container);this.rotationCount=b.rotationCount;this.rotationsPerFrame=b.rotationsPerFrame;this.pixelsPerRotation=b.pixelsPerRotation;this.features=this.options.features;this.frameImages=[];this.featureBoxes={};this.isLoaded=!1;this.bind()};j.prototype={updateViewer:function(){throw"Implement updateViewer in a subclass";
},getViewer$:function(){throw"Implement getViewer$ i na subclass";},bind:function(){function a(a){1===a.which&&c.move(a.screenX,a.screenY)}function b(b){1===b.which&&(c.up(b.screenX,b.screenY),d(document).unbind("mousemove",a))}var c=this;this.$container.bind("mousedown",function(e){1===e.which&&(c.down(e.screenX,e.screenY),d(document).one("mouseup",b),d(document).bind("mousemove",a))});this.$container[0].ontouchstart=function(a){a.preventDefault();c.down(a.targetTouches[0].screenX,a.targetTouches[0].screenY);
return!0};this.$container[0].ontouchmove=function(a){a.preventDefault();c.move(a.targetTouches[0].screenX,a.targetTouches[0].screenY);return!0};this.$container[0].ontouchend=function(a){a.preventDefault();c.up(a.changedTouches[0].screenX,a.changedTouches[0].screenY);return!0};void 0!=document.addEventListener&&null!=document.addEventListener&&document.addEventListener("touchstart",function(){},!1);this.$container.bind("mouseenter",function(){c.$featureBoxContainer.show().gx(i,c.options.featureMouseInTime,
c.options.featureMouseInEasing)});this.$container.bind("mouseleave",function(){c.$featureBoxContainer.gx(f,c.options.featureMouseOutTime,c.options.featureMouseOutEasing,function(){c.$featureBoxContainer.hide()})})},load:function(){if(!this.isLoaded){this.showLoading();var a=this;this.loadAllFrames(function(){a.isLoaded=!0;a.setRotation(0);a.getViewer$().appendTo(a.$container);a.$container.css({width:a.$sourceElement.width(),height:a.$sourceElement.height()});a.hideLoading(function(){a.$sourceElement.replaceWith(a.$container)})})}},
showLoading:function(){if(this.options.showLoading){var a=this;this.$sourceElement.css({cursor:"wait"});this.loadingTimeout=window.setTimeout(function(){var b=a.$sourceElement.offset();b.width=a.$sourceElement.width();b.height=a.$sourceElement.height();a.$sourceElement.animate({opacity:0.5},500);a.$loading=d(document.createElement("img")).attr("src","images/loader.gif").css({position:"absolute",left:b.left+(b.width-32)/2,top:b.top+(b.height-32)/2}).appendTo(document.body)},0)}},hideLoading:function(a){this.options.showLoading?
(this.loadingTimeout&&window.clearTimeout(this.loadingTimeout),this.$sourceElement.css({cursor:""}).animate({opacity:1},200,a),this.$loading&&(this.$loading.remove(),this.$loading=null)):a()},loadAllFrames:function(a){function b(){--e;0>=e&&a()}var c=Math.ceil(this.rotationCount/this.rotationsPerFrame),e=c,d;for(d=0;d<c;++d)this.loadFrameImage(d,b)},wrapRotation:function(a){var b=this.rotationCount;if(0===b)return 0;for(;a>=b;)a-=b;for(;0>a;)a+=b;return a},setRotation:function(a){if(parseInt(a,10)!=
a)throw alert("rotation: "+a),"Rotation number must be an integer";a=parseInt(a,10);if(0>a||a>=this.rotationCount)throw"Rotation number out of range";a!==this.currentRotation&&(this.currentRotation=a,this.updateViewer(),this.updateFeatureBoxes())},updateFeatureBoxes:function(){var a=this,b=this.getFeatures(this.currentRotation),c=d(c).map(function(){return this.name}).get();d.each(this.featureBoxes,function(b,h){0>d(c).index(b)&&!h.isFadingOut&&(h.gx(f,a.options.featureFadeOutTime,a.options.featureFadeOutEasing,
function(){delete a.featureBoxes[b];h.hide()}),h.isFadingOut=!0)});d(b).each(function(){var b=a.featureBoxes[this.name];b?(b.isFadingOut=!1,b.show(),b.gx(d.extend({},i,this.position),a.options.featureFadeInTime,a.options.featureFadeInEasing)):(b=d(document.createElement("div")).addClass("orbiter-feature").css(this.position).css({position:"absolute"}).css(f).attr("title",this.name).gxInit({queue:"cancel"}).gx(i,a.options.featureFadeInTime,a.options.featureFadeInEasing).appendTo(a.$featureBoxContainer),
g(b).addClass("feature-tool-tip"));a.featureBoxes[this.name]=b})},getFeatures:function(a){var b=[];d.each(this.features,function(c,d){d[a]&&b.push({name:c,position:d[a]})});return b},loadFrameImage:function(a,b){var c=this.frameImages[a];if(c)c.data("callbacks")?c.data("callbacks").push(b):b(c);else{var c=this.options.frameImage,e;"function"===typeof c&&(c=c(this.$sourceElement,a));"string"===typeof c&&(e=c,c=new Image);c.tagName&&"IMG"===c.tagName&&(c=d(c));if(!(c instanceof d))throw"image should be a jQuery object";
this.frameImages[a]=c;c.data("callbacks",[b]);c.load(function(){d(c.data("callbacks")).each(function(){this(c)})});e&&c.attr("src",e)}},down:function(a,b){this.isDown=!0;this.startX=a;this.startY=b;this.startTick=this.getTimeTick();this.startRotation=this.currentRotation;this.endMomentum()},move:function(a){this.isDown&&(a=Math.round((this.startX-a)/this.pixelsPerRotation),this.setRotation(this.wrapRotation(this.startRotation+a)))},up:function(a){this.isDown&&(this.isDown=!1,this.startMomentum((this.startX-
a)/(this.getTimeTick()-this.startTick)))},getTimeTick:function(){return(new Date).getTime()},startMomentum:function(a){function b(){d-=0.05;if(0>d)f.endMomentum();else{c+=h;f.setRotation(f.wrapRotation(c));var a=20/d;400<a||(f.momentumTimer=window.setTimeout(b,a))}}if(0!==a){var c=this.currentRotation,d=Math.min(2.5,Math.abs(a)),h=Math.abs(a)/a;if(!(1>d)){var f=this;b()}}},endMomentum:function(){window.clearTimeout(this.momentumTimer)}};g.enter=function(){var a=d(this),b=a.data("toolTipIt");a.offset();
b.hideTimer&&(window.clearTimeout(b.hideTimer),b.hideTimer=null);b.$toolTip.text(b.title).show().gx(i,300,"Quad:Out");b.$toolTip.appendTo(a).css({top:-b.$toolTip.outerHeight()-1})};g.leave=function(){var a=d(this).data("toolTipIt");a.hideTimer&&(window.clearTimeout(a.hideTimer),a.hideTimer=null);a.hideTimer=window.setTimeout(function(){a.hideTimer=null;a.$toolTip.gx(f,300,"Sine",function(){a.$toolTip.css({top:0}).remove()})},500)};var k=function(a){a=d.extend({},k.defaultOptions,a);this.each(function(){var b=
d(this);try{var c;a:{try{if(document.createElement("canvas").getContext){c=m;break a}}catch(e){}c=l}var f=new c(b,a);switch(a.loadTrigger){default:f.load();break;case "click":b.one("mousedown",function(){f.load()});break;case "hover":b.one("mouseenter",function(){f.load()})}b.data("orbiter",f)}catch(g){console.log("Exception in $.fn.orbit: "),console.log(g)}})};k.defaultOptions={rotationCount:32,frameImage:function(a,b){var c=a.attr("src"),c=c.replace("-thumb","-"+b);return c=c.replace(/#.*$/,"")},
features:{},featureFadeInTime:300,featureFadeOutTime:600,featureFadeInEasing:"Sine:Out",featureFadeOutEasing:"Sine:Out",featureMouseInTime:500,featureMouseOutTime:1E3,featureMouseInEasing:"Expo",featureMouseOutEasing:"Expo",rotationsPerFrame:1,pixelsPerRotation:10,showLoading:!1,loadTrigger:"now"};d.fn.orbit=k;d.fn.disableSelection=function(){return this.bind("selectstart.disableSelection mousedown.disableSelection",function(a){a.preventDefault()}).attr("unselectable","unselectable")};d(function(){d("img.auto-orbit").each(function(){var a=
d(this),b=a.attr("src").replace(/^[^#]*#/,""),b=d.parseJSON(b);a.orbit(b)})})})(jQuery);